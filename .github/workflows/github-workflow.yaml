name: CI/CD with Ollama Cache

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  OLLAMA_MODELS_DIR: ~/.ollama/models

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    # Install Ollama
    - name: Install Ollama
      run: |
        curl -fsSL https://ollama.com/install.sh | sh
        ollama --version

    # Start Ollama service and verify it's running
    - name: Start Ollama Service
      run: |
        # Start ollama in the background
        ollama serve &
        
        # Wait for the service to be ready
        timeout=30
        while ! curl -s http://localhost:11434/api/version > /dev/null; do
          if [ $timeout -le 0 ]; then
            echo "Timeout waiting for Ollama service"
            exit 1
          fi
          echo "Waiting for Ollama service to start... ($timeout seconds remaining)"
          sleep 1
          timeout=$((timeout - 1))
        done
        echo "Ollama service is ready"

    # Cache Ollama models
    - name: Cache Ollama Models
      id: cache-ollama
      uses: actions/cache@v4
      with:
        path: ~/.ollama/models
        key: ${{ runner.os }}-ollama-${{ hashFiles('models.txt') }}
        restore-keys: |
          ${{ runner.os }}-ollama-

    # Download models if not cached
    - name: Download Ollama Models
      if: steps.cache-ollama.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/.ollama/models
        while IFS= read -r model || [[ -n "$model" ]]; do
          if [[ ! -z "$model" && ! "$model" =~ ^# ]]; then
            echo "Pulling model: $model"
            # Add timeout and retry logic for model pulling
            for i in {1..3}; do
              if ollama pull "$model"; then
                break
              fi
              if [ $i -eq 3 ]; then
                echo "Failed to pull model $model after 3 attempts"
                exit 1
              fi
              echo "Retry $i pulling model $model..."
              sleep 5
            done
          fi
        done < models.txt

    # Your build steps here
    - name: Build and Test
      run: |
        # Add your build commands here
        echo "Building with cached Ollama models..."

    # Optional: Upload models as artifacts for debugging
    - name: Upload Models Directory
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ollama-models
        path: ~/.ollama/models/
        retention-days: 1

    # Cleanup
    - name: Cleanup
      if: always()
      run: |
        pkill ollama || true
        sleep 2