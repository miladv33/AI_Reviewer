name: 'DeepSeek PR Review'
description: 'Automatically review pull requests using DeepSeek AI model via Ollama'
author: 'Your Name'

branding:
  icon: 'eye'  # Choose from: https://feathericons.com/
  color: 'blue' # Choose from: white, yellow, blue, green, orange, red, purple, gray-dark

inputs:
  github-token:
    description: 'GitHub token for commenting on PRs'
    required: true
    default: ${{ github.token }}
  custom-prompt:
    description: 'Custom prompt for the AI review'
    required: false
    default: 'Please review the following pull request changes and provide feedback.'
  model:
    description: 'DeepSeek model to use'
    required: false
    default: 'deepseek-r1:14b'

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Get PR changes
      shell: bash
      run: |
        echo "=== Getting PR Changes ==="
        
        echo "Getting changed files..."
        echo "Changed files:" > pr_changes.txt
        git diff --name-status ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | tee -a pr_changes.txt
        
        echo -e "\nGetting detailed changes..."
        echo -e "\nDetailed changes:" >> pr_changes.txt
        git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | tee -a pr_changes.txt
        
        {
          echo 'PR_CHANGES<<EOF'
          cat pr_changes.txt
          echo 'EOF'
        } >> $GITHUB_ENV

    - name: Install Ollama
      shell: bash
      run: curl -fsSL https://ollama.com/install.sh | sh

    - name: Read custom prompt
      shell: bash
      id: read-prompt
      run: |
        if [ -f ".github/workflows/pr_review_prompt.txt" ]; then
          CUSTOM_PROMPT=$(cat .github/workflows/pr_review_prompt.txt)
          echo "Using prompt from pr_review_prompt.txt file"
        else
          CUSTOM_PROMPT="${{ inputs.custom-prompt }}"
          echo "Using prompt from action input"
        fi
        echo "CUSTOM_PROMPT=$(echo "$CUSTOM_PROMPT" | tr '\n' ' ')" >> $GITHUB_ENV

    - name: Run DeepSeek model
      shell: bash
      id: run-model
      run: |
        # Combine prompt and changes
        echo "${{ inputs.custom-prompt }}" > full_prompt.txt
        echo -e "\nChanges to review:\n$PR_CHANGES" >> full_prompt.txt
        
        # Run the model and capture complete response
        response=$(cat full_prompt.txt | ollama run ${{ inputs.model }} 2>/dev/null |
          grep -v '^[0-9]' |
          grep -v '25[hl]' |
          grep -v '⠙\|⠸\|⠴\|⠦\|⠧\|⠇\|⠏\|⠋\|⠙\|⠹\|⠼' |
          sed '/^<think>/,/^<\/think>/d' |
          sed 's/^\[[^]]*\]//g' |
          sed 's/[`"'\'']/\\&/g' |
          sed 's/^###\([^#]\)/### \1/g' |
          sed 's/^####\([^#]\)/#### \1/g' |
          sed 's/^-\([^ ]\)/- \1/g' |
          sed 's/\*\*\([^*]\+\)\*\*/\*\*\1\*\*/g' |
          sed '/^#/i\\' |
          sed 's/[${}]/\\&/g' |
          sed '/^[[:space:]]*$/d' |
          tr '\n' '\r' |
          sed 's/\r/\\n/g')
        
        echo "response=$response" >> $GITHUB_OUTPUT

    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const modelResponse = process.env.RESPONSE || '';
          const cleanResponse = modelResponse
            .replace(/\\n/g, '\n')
            .replace(/[^\x20-\x7E\n]/g, '')
            .trim();
            
          const aiReview = [
            '# AI Code Review',
            '',
            cleanResponse,
            '',
            '---',
            '*This review was automatically generated by DeepSeek AI.*'
          ].join('\n');
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: aiReview
          });
